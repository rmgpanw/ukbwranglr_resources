---
title: 'Tutorial: Describing diabetes in the UK Biobank cohort'
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  html_notebook:
    code_folding: hide
    df_print: paged
    toc: yes
    toc_float:
      toc_collapsed: yes
    toc_depth: 3
    number_sections: yes
    theme: lumen
editor_options:
  chunk_output_type: inline
---

```{r}
# install.packages("devtools")
devtools::install_github("rmgpanw/ukbwranglr")
library(ukbwranglr)
library(tidyverse)
```

# Overview

**Aims:** 

1. To identify UK Biobank participants who have type 1/2 diabetes
1. Compare individuals with diabetes vs those without to identify potential risk factors

Analyses will be performed using dummy UKB main dataset (generated by [tofu](https://github.com/spiros/tofu)) and primary care (**TODO**) data provided with `ukbwranglr`. 

>Note: the list of diagnostic codes for diabetes is incomplete. The purpose of this notebook is not to provide a prescriptive analysis plan, but rather to illustrate some of the key functions in `ukbwranglr` to help with addressing the above aims.

# Identify diabetes

1. Select diagnostic codes
1. Load data
1. Identify UK Biobank participants with these codes (taking the earliest record date as date of diagnosis) from the following data sources:

  - Self-reported medical conditions (FieldIDs [20002](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20002) and [20008](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20008))
  - Hospital data (Field IDs [41271](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=41271), [41270](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=41270), [41281](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=41281) and [41280](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=41280))
  - Death certificate data (Field IDs [40001](https://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=40001) and [40002](https://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=40002))
  - Primary care data (separate table - not included here yet)
  
>See ['UKB: Disease outcomes'](https://rmgpanw.github.io/ukbwranglr/articles/ukb_disease_outcomes.html) on `ukbwwranglr` package website for further details.

## Diagnostic codes for diabetes

- ICD10:

  - E10, E11
  
- Read 2 codes

  - C08, C09, C10E, C10F

```{r}
# diagnostic codes of interest
dm_codes <- c("C08", 
              "C09", 
              "C10E", 
              "C10F", 
              "E10",
              "E11")
```

## Load dummy data

1. Create data dictionary (`pheno_data_dict()`)
1. Load data (`read_pheno()`)

```{r}
# load data
dummy_data_path <- system.file("extdata", "dummy_ukb_data.csv", package = "ukbwranglr")
data_dict <- pheno_data_dict(dummy_data_path, delim = ",")
pheno_data <- read_pheno(path = dummy_data_path, 
                         pheno_data_dict = data_dict,
                         delim = ",")

# view first few columns
pheno_data[, 1:5] %>% 
  head()
```

## Extract diabetes codes and ascertain earliest recorded date per participant

```{r}
# gather all diagnostic codes from selected sources in long format dataframe
all_diagnostic_codes <-
  get_all_diagnostic_codes_multi(
    function_list = list(
      get_self_report_non_cancer_diagnoses_icd10,
      get_hes_icd9_diagnoses,
      get_hes_icd10_diagnoses,
      get_death_data_icd10_diagnoses
    ),
    ukb_pheno = pheno_data,
    data_dict = data_dict,
    ukb_codings = data.table::fread(
      "https://biobank.ctsu.ox.ac.uk/~bbdatan/Codings.tsv",
      colClasses = c('character'),
      sep = "\t",
      quote = " ",
      na.strings = c("", "NA")
    )
  )

# extract earliest recorded code per individual (eid)
earliest_dm_record_per_eid <-
  get_first_diagnostic_code_record(all_diagnostic_codes,
                                   dm_codes)

# view result
head(earliest_dm_record_per_eid)
```

## Add this to main dataset

```{r}
pheno_data <- earliest_dm_record_per_eid %>% 
  select(eid,
         date) %>% 
  right_join(pheno_data, by = "eid") %>% 
  rename(dm_diagnosis_date = date) %>% 
  mutate(dm_diagnosis = case_when(
    !is.na(dm_diagnosis_date) ~ TRUE,
    is.na(dm_diagnosis_date) ~ FALSE
  ))
```


# Summarise continuous variables (mean values for repeated measurements)

1. Remove columns that have now been processed (diagnostic codes) or are not required
1. Extract average values for all continuous measurements (removing the original columns)
1. Summarise, goruping by diabetes status

```{r}
# remove columns that have been processed/not required
diagnoses_and_medications_cols <- get_colnames_for_fieldids(
  data_dict = data_dict,
  field_ids =
    c(
      ## > First occurrence - https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=2404
      "130706",
      "130708",
      "130710",
      "130712",
      "130714",
      "132202",
      
      ## > Touchscreen - https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=100044
      "2443",
      "2976",
      "2986",
      
      ## > Verbal interview - https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20002
      ### Non-cancer illness code, age and year when diagnosed
      "20002",
      "20009",
      "20008",
      
      ### Cancer illness code, age and year when diagnosed
      "20001",
      "20007",
      "20006",
      
      ## > Hospital inpatient diagnoses - https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=2002
      ### ICD10 and ICD9, code and date of first in-patient diagnosis
      "41270",
      "41280",
      "41271",
      "41281",
      
      ## > Death register records - https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=100093
      ### ICD10, primary and secondary causes of death
      "40001",
      "40002",
      
      ## > Cancer register data - https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=100092
      ### ICD9, ICD10, age when diagnosed and date of diagnosis
      "40013",
      "40006",
      "40008",
      "40005",
      
      # MEDICATIONS
      ## > Verbal interview -
      ### Medications
      "20003",
      "20076"
    )
)

pheno_data <- pheno_data %>% 
  select(-all_of(diagnoses_and_medications_cols))

data_dict <- data_dict %>% 
  filter(!(descriptive_colnames %in% diagnoses_and_medications_cols)) 
## TODO correct `summarise_rowise_numerical_mean_min_max` - currently raises
## error if data_dict contains colnames that do not exist in pheno_data

# extract average values for continuous measurements, removing the original columns
pheno_data <- summarise_rowise_numerical_mean_min_max(ukb_pheno = pheno_data, 
                                                      ukb_mapping_df = data_dict, 
                                                      mean_min_max = "rowMeans")

continuous_variable_colnames <- data_dict %>% 
  filter(ValueType %in% c("Continuous", "Integer")) %>% 
  .$descriptive_colnames


pheno_data <- pheno_data %>% 
  select(-all_of(continuous_variable_colnames))
```

```{r}
# summarise by diabetes status
pheno_data %>% 
  group_by(dm_diagnosis) %>% 
  my_skim()
```

